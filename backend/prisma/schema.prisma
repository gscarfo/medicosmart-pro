// Prisma Schema per MedicoSmart Professional
// Database PostgreSQL per gestione prescrizioni mediche

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Utenti del sistema (medici e amministratori)
model User {
  id            String    @id @default(uuid())
  username      String    @unique
  email         String    @unique
  passwordHash  String
  role          UserRole  @default(DOCTOR)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relazioni
  profile       DoctorProfile?
  patients      Patient[]
  prescriptions Prescription[]
  auditLogs     AuditLog[]

  @@map("users")
}

enum UserRole {
  ADMIN
  DOCTOR
}

// Profilo professionale del medico
model DoctorProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  title       String   // Dott., Dott.ssa, Prof., etc.
  fullName    String
  fiscalCode  String?  // Codice fiscale del medico
  address     String   // Indirizzo studio
  phone       String
  email       String
  specialization String? // Specializzazione medica
  licenseNumber String? // Numero iscrizione all'ordine
  logoUrl     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relazioni
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("doctor_profiles")
}

// Pazienti gestiti dal medico
model Patient {
  id            String   @id @default(uuid())
  doctorId      String
  firstName     String
  lastName      String
  birthDate     DateTime
  fiscalCode    String?  // Cryptato per GDPR
  gender        Gender?
  address       String?
  phone         String?
  email         String?
  notes         String?  // Note mediche - cryptate
  consentGiven  Boolean  @default(false)
  consentDate   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  // Relazioni
  doctor        User     @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  prescriptions Prescription[]

  @@index([doctorId])
  @@index([fiscalCode])
  @@map("patients")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

// Prescrizioni mediche
model Prescription {
  id            String   @id @default(uuid())
  doctorId      String
  patientId     String
  content       String   // Contenuto prescrizione - cryptato
  diagnosis     String?  // Diagnosi/quesito diagnostico
  pdfUrl        String?  // Path del PDF generato
  pdfHash       String?  // Hash del PDF per verifica integrità
  status        PrescriptionStatus @default(DRAFT)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  signedAt      DateTime?
  deletedAt     DateTime?

  // Relazioni
  doctor        User     @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  communications Communication[]

  @@index([doctorId])
  @@index([patientId])
  @@index([createdAt])
  @@map("prescriptions")
}

enum PrescriptionStatus {
  DRAFT
  SIGNED
  SENT
  PRINTED
  CANCELLED
}

// Log delle comunicazioni inviate (email, SMS)
model Communication {
  id            String   @id @default(uuid())
  prescriptionId String
  type          CommunicationType
  recipient     String   // Email o telefono
  status        DeliveryStatus @default(PENDING)
  sentAt        DateTime?
  deliveredAt   DateTime?
  errorMessage  String?
  createdAt     DateTime @default(now())

  // Relazioni
  prescription  Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)

  @@map("communications")
}

enum CommunicationType {
  EMAIL
  SMS
}

enum DeliveryStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

// Audit log per conformità GDPR
model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  action      String   // CREATE, READ, UPDATE, DELETE
  entity      String   // Tabella entità (patients, prescriptions, etc.)
  entityId    String   // ID dell'entità coinvolta
  oldValue    Json?    // Valore precedente (per UPDATE)
  newValue    Json?    // Nuovo valore (per CREATE/UPDATE)
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  // Relazioni
  user        User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
